@using System.Text.Json
@using System.Text
@using CRUDBlazor.Client.Services.Producto
@using CRUDBlazor.Shared.Productos
@using System.Web
@using CRUDBlazor.Shared.Proveedores
@inject HttpClient http
@inject NavigationManager NavigationManager
@inject ApiProperties prop 
@page "/productos"
<h3>Producto</h3>
<div class="container-fluid" style="max-width: 100%; overflow-x: hidden;">
    @if (prop.productos == null)
    {
        <div class="spinner-border" role="status">
            <span class="sr-only"></span>
        </div>
    }
    else
    {
        <ConfiguracionPaginacion PaginasTotales="prop.paginasTotales" PaginaActual="prop.paginaActual" PaginaSeleccionada="PaginaSeleccionada"></ConfiguracionPaginacion>
        <EditForm Model="this" OnValidSubmit="GetBuscarProducto">
            <DataAnnotationsValidator />
            <ValidationSummary />
            <InputText id="buscar" @bind-Value="prop.buscar" class="form-control" placeholder="Buscar producto" />
            <select class="form-select mt-2" @bind="prop.ordenarPorPrecio">
                <option value="">Ordenar por precio</option>
                <option value="asc">Ascendente</option>
                <option value="desc">Descendente</option>
            </select>
            <select class="form-select mt-2" @bind="prop.idProveedor">
                <option value="0">Seleccionar proveedor</option>
            @foreach (var proveedor in prop.proveedores)
            {
                <option value="@proveedor.id">@proveedor.nombreProveedor</option>
            }
        </select>

            <button type="submit" class="btn btn-primary mt-2">Buscar</button>
        </EditForm>
        <button @onclick="LimpiarFiltros">Limpiar filtros</button>

        @foreach (var producto in prop.productos)
        {
            <div class="card mb-3">
                <div class="card-header">
                    <h5>Datos del Producto</h5>
                </div>
                <div class="card-body">
                    <p class="card-text"><strong>Nombre Producto:</strong> @producto.nombreProducto</p>
                    <p class="card-text"><strong>Descripcion:</strong> @producto.descripcion</p>
                    <p class="card-text">
                        <strong>Imagen:</strong> <br/><img src="@producto.imagen" alt="Imagen del producto" style="width:100px; height:100px;" />
                    </p>
                    <p class="card-text"><strong>Cantidad:</strong> @producto.cantidad</p>
                    <p class="card-text"><strong>Precio:</strong> @producto.precio</p>
                    <p class="card-text"><strong>Nombre del proveedor:</strong> @producto.idProveedorNavigation.nombreProveedor</p>

                </div>
                <div class="card-footer d-flex justify-content-between">

                    <div>
                        <AuthorizeView Roles="administrador">
                        <a href="/deleteproducto/@producto.id" class="btn btn-danger mt-2 ml-2">Eliminar</a>
                        </AuthorizeView>
                        <AuthorizeView Roles="administrador">
                        <a href="/actualizarproducto/@producto.id" class="btn btn-primary mt-2 ml-2">Actualizar</a> 
                        </AuthorizeView>
              </div>
                    <div class="card-footer d-flex justify-content-between">
                        <div>
                            <input type="number" @bind="prop.cantidades[producto.id]" min="1" max="@producto.cantidad" />
                            <button class="btn btn-primary mt-2" @onclick="() => AgregarAlCarrito(producto.id)">Agregar al carrito</button>

                        </div>                    
                    </div>
                    @if (prop.showAlert)
                    {
                        <div class="alert alert-danger mt-2" role="alert">
                            @prop.alertMessage
                        </div>
                    }
                </div>
            </div>
        }
    }
</div>
<a href="/crearproducto" class="btn btn-info">Crear Producto</a>
@code {
    protected override async Task OnInitializedAsync()
    {
        //Al array que inicialmete esta vacio se le asigna los productos que debe mostrar
        prop.productos = await GetProducto();
        // Inicializa el array 'proveedores' con la lista de proveedores
        prop.proveedores = await GetProveedores();
        /*Se inicializa un bucle que recorre el array de productos y asigna la cantidad a cada producto, esta cantidad corresponde
         * con la cantidad que tu agregas de ese producto al carrito
        */
        foreach (var producto in prop.productos)
        {

            prop.cantidades[producto.id] = 1; 
        }    
    }
    private async Task<ProductosViewModel[]> GetProducto()
    {
        //Se declara una variable que almacena la url a la que se va ha realizar una petición get
        //lo que hay despues del '?' son parametros de consulta.
        string url = $"api/Producto?pagina={prop.paginacion.Pagina}&CantidadAMostrar={prop.paginacion.CantidadAMostrar}";
        //Si id proveedor es distinto de 0 agrega este parametro de consulta a la url
        if (prop.idProveedor != 0)
        {
            url += $"&idProveedor={prop.idProveedor}";
        }
        //Aquí es donde se realiza esa peticion get al servidor pasando la variable anterior
        var response = await http.GetAsync(url);
        //Si la respuesta es válida...
        if (response.IsSuccessStatusCode)
        {
            //Muestra el número de páginas totales almacenado en la cabecera de la petición
            prop.paginasTotales = int.Parse(response.Headers.GetValues("totalPaginas").FirstOrDefault());
        }
        //Lee y serializa la petición
        var content = await response.Content.ReadAsStringAsync();
        //Deserializa la respuesta del servidor para mostrar los datos al usuario.
        return JsonSerializer.Deserialize<ProductosViewModel[]>(content);
    }
 
    private async Task GetBuscarProducto()
    {
        // Si 'buscar' es null, se convierte en una cadena vacía
        prop.buscar = prop.buscar ?? string.Empty;
        // Si el campo de búsqueda está vacío...
        if (string.IsNullOrEmpty(prop.buscar))
        {
            // ...se llama a la función GetProducto() para obtener todos los productos
            prop.productos = await GetProducto();
        }
        else
        {
            // Se crea una lista para almacenar todos los productos encontrados
            List<ProductosViewModel> todosLosProductos = new List<ProductosViewModel>();
            // Este bucle recorre todas las páginas de productos
            for (int i = 1; i <= prop.paginasTotales; i++)
            {
                // Realizar una petición GET para cada página
                var response = await http.GetAsync($"api/Producto?pagina={i}&CantidadAMostrar={prop.paginacion.CantidadAMostrar}&buscar={prop.buscar}&idProveedor={prop.idProveedor}");
                //Lee y serializa la respuesta
                var content = await response.Content.ReadAsStringAsync();
                //Se deserializa la respuesta
                var productosEnPagina = JsonSerializer.Deserialize<ProductosViewModel[]>(content);
                // Se añaden los productos encontrados en la página actual a la lista de 'todosLosProductos'
                todosLosProductos.AddRange(productosEnPagina);
            }
            // Convertir la lista a un array y actualizar 'productos'
            prop.productos = todosLosProductos.ToArray();
            // Actualizar 'cantidades' para los nuevos productos
            foreach (var producto in prop.productos)
            {
                // Si el producto no está en 'cantidades', se añade con valor 1. Esto se usa para agregar productos al carrito, no 
                // refleja la cantidad de producto disponible.
                if (!prop.cantidades.ContainsKey(producto.id))
                {
                    prop.cantidades[producto.id] = 1;
                }
            }
        }
        // Ordenar por precio si el criterio ha cambiado, ordenarPorPrecio esta variable almacena el estado actual y ordenarPorPrecioAnterior
        //almacena el estado anrior los criterios son:
            //null--> no se ha usado el filtro.
            //asc-->orden ascendente
            //desc-->orden descente

        if (prop.ordenarPorPrecio != prop.ordenarPorPrecioAnterior)
        {
            await OrdenarPorPrecio();
            prop.ordenarPorPrecioAnterior = prop.ordenarPorPrecio;
        }
        // Filtrar por proveedor si el proveedor seleccionado ha cambiado. 'idProveedor' almacena el estado actual y 'idProveedorAnterior'
        // almacena el estado anterior. Los posibles estados son:
        // 0 --> ningún proveedor ha sido seleccionado.
        // 1, 2, 3, etc. --> corresponde al ID del proveedor seleccionado.
        if (prop.idProveedor != prop.idProveedorAnterior)
        {
            await OrdenarPorProveedor();
            prop.idProveedorAnterior = prop.idProveedor;
        }
    }
    private async Task OrdenarPorPrecio()
    {
        var response = await http.GetAsync($"api/Producto?pagina={prop.paginacion.Pagina}&CantidadAMostrar={prop.paginacion.CantidadAMostrar}&ordenarPorPrecio={prop.ordenarPorPrecio}");
        var content = await response.Content.ReadAsStringAsync();
        prop.productos = JsonSerializer.Deserialize<ProductosViewModel[]>(content);
        /*Ha la hora de hacer la busqueda esto hay que ponerlo de nuevo para que se asigne bien las cantidades a cada producto
         * esto corresponde con la cantidad del producto que vas a mandar al carrito
        */
        foreach(var producto in prop.productos)
        {
            if (!prop.cantidades.ContainsKey(producto.id))
            {
                prop.cantidades[producto.id] = 1;
            }
        }
    }
    private async Task OrdenarPorProveedor()
    {
        //Si no se ha seleccionado ningun proveedor sale de esta funcion.
        if (prop.idProveedor == 0)
        {

            return;
        }
        var response = await http.GetAsync($"api/Producto?pagina={prop.paginacion.Pagina}&CantidadAMostrar={prop.paginacion.CantidadAMostrar}&idProveedor={prop.idProveedor}");
        var content = await response.Content.ReadAsStringAsync();
        prop.productos = JsonSerializer.Deserialize<ProductosViewModel[]>(content);
        foreach (var producto in prop.productos)
        {
            if (!prop.cantidades.ContainsKey(producto.id))
            {
                prop.cantidades[producto.id] = 1;
            }
        }
    }
    private async Task<ProveedorViewModel[]> GetProveedores()
    {
        var response = await http.GetAsync("api/Proveedor");
        var content = await response.Content.ReadAsStringAsync();
        return JsonSerializer.Deserialize<ProveedorViewModel[]>(content);
    }  
    private async Task PaginaSeleccionada(int pagina)
    {
       
        prop.paginacion.Pagina = pagina;
        prop.productos = await GetProducto();
        prop.proveedores = await GetProveedores();
       /*Recorremos el array de productos y ha cada producto se le asigna una cantidad. Esta cantidad corresponde con los productos
        * que se van ha agregar al carrito.
        */
        foreach (var producto in prop.productos)
        {
            if (!prop.cantidades.ContainsKey(producto.id))
            {
                prop.cantidades[producto.id] = 1; 
            }
        }
        prop.paginaActual = pagina;
        
    }
    private async Task AgregarAlCarrito(int idProducto)
    {
        // Obtiene la cantidad del diccionario 'cantidades' para pasar esas cantidades al carrito
        int cantidad = prop.cantidades[idProducto];
        // Preparamos una petición especial donde necesitamos pasar ciertas propiedades en formato JSON.
        // En este caso, para agregar un producto al carrito, necesitamos 'idProducto' y 'cantidad'.
        // Esta línea de código crea el contenido de la petición serializando 'idProducto' y 'cantidad' a JSON.
        var content = new StringContent(JsonSerializer.Serialize(new { idProducto, cantidad }), Encoding.UTF8, "application/json");   
        //Hace la peticion al servidor pasandole la idProducto y cantidad anteriormente serializada
        var response = await http.PostAsync("api/Producto/carrito", content);
        if (response.IsSuccessStatusCode)
        {
            //Si el producto se agrego correctamente muestra los productos con el nuevo producto
            prop.productos = await GetProducto();
        }
        else
        {
            //Si ha ocurrido un error muestra el mensaje de error
            var message = await response.Content.ReadAsStringAsync();
            ShowAlert(message);
        }
    }
    private async Task LimpiarFiltros()
    {
        // Restablece las variables de filtro a sus valores predeterminados
        prop.buscar = null;
        prop.ordenarPorPrecio = null;
        prop.ordenarPorPrecioAnterior = null;
        prop.idProveedor = 0;
        prop.idProveedorAnterior = 0;

        // Obtiene todos los productos sin aplicar ningún filtro
        prop.productos = await GetProducto();
    }

    private void ShowAlert(string message)
    {
       prop.showAlert = true;
        prop.alertMessage = message;
    }

}
